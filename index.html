<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <title>Bookenizer: Online Reservation Service</title>
    <link rel="shortcut icon" href="favicon.ico"/>
    <link rel="stylesheet" type="text/css" href="/styles/layout.css" medvia="all">
    <link rel="stylesheet" type="text/css" href="/styles/print.css" media="print">
    <link rel="stylesheet" type="text/css" href="/styles/jscal2.css" media="all">
    <link rel="stylesheet" type="text/css" href="/styles/jquery.multiSelect.css" media="screen">
    <!--<link rel="stylesheet" type="text/css" href="/styles/pagination.css" media="screen">-->
</head>
<body class="popular">
<div id="ltemplate"></div>
<div id="container">
    <div id="wrapper">
        <div id="content">

            <div id="head">

                <div id="topbar">

                </div>

                <div class="close-full"></div>

                <div id="logobar" class="vcard"></div>
            </div>

            <span id="searchbar_ph"></span>

            <div id="main">
                <div class="opener"></div>

                <div id="sidebar">
                    <span id="topdestblock" class="template_emb"></span>
                    <div class="hr"></div>
                    <span id="statistics" class="template_emb"></span>
                </div>
                <div id="mainbar">
                    <span id="hotelslist" class="template_emb"></span>
                </div>
                <div class="closer"></div>
            </div>

        </div>
    </div>
</div>
<div id="footer"></div>

<script type="text/javascript" src="/scripts/debug/xdate.js"></script>
<script type="text/javascript" src="/scripts/debug/jscal2.js"></script>
<script type="text/javascript" src="/scripts/lang/en.js"></script>
<script type="text/javascript" src="/scripts/lang/ru.js"></script>
<script type="text/javascript" src="/scripts/lang/de.js"></script>
<script type="text/javascript" src="/scripts/debug/json2.js"></script>
<script type="text/javascript" src="/scripts/jquery-1.6.1.min.js"></script>
<script type="text/javascript" src="/scripts/debug/jquery.form.js"></script>
<script type="text/javascript" src="/scripts/debug/jquery.bgiframe.min.js"></script>
<script type="text/javascript" src="/scripts/debug/jquery.multiSelect.js"></script>
<script type="text/javascript" src="/scripts/debug/underscore.js"></script>
<script type="text/javascript" src="/scripts/debug/backbone.js"></script>
<script type="text/javascript" src="/scripts/debug/mustache.js"></script>
<script type="text/javascript" src="/scripts/debug/ICanHaz.js"></script>
<script type="text/javascript" src="/scripts/debug/class.js"></script>
<script type="text/javascript" src="/scripts/debug/jquery.jstore.js"></script>
<script type="text/javascript" src="/scripts/debug/gsuggest.js"></script>
<script type="text/javascript" src="/scripts/debug/jquery.pagination.js"></script>
<script type="text/javascript" src="/scripts/models.js"></script>


<script type="text/javascript">
    (function(defLanguage) {
        var nightsCount=function(elem){
                    debugger;
        };
        var search=function(){
            var formToProcess=$("#searchform_".concat(window._configuration.get("searchType"))).ajaxForm();
            debugger;
            if(window._configuration.get("searchType")==="quick"){
                  var strQuery=formToProcess.serializeArray();
                  //formToProcess.ajaxSubmit();
            }
            else{
                  var strQuery=formToProcess.serializeArray();
                debugger;
            }
            return false;
        }

        var suggestor=function(){
            var curLang=window._configuration.get("lang");
            var self=this;
            $.gsuggest({
                inlineText: function(data) { return data.city + ", " + data.country },
                inlineId: function(data) { return data.cityId },
                dataSort: function(a,b) { return (a.city < b.city) ? -1 : ((a.city == b.city) ? 0 : 1); }
            });
            var cal=Calendar.setup( {selectionType : Calendar.SEL_MULTIPLE, timeFormat:24, firstDay : 0, weekNumbers : false, showOthers:true, onSelect:function(){fixDate(this.inputField.id);this.hide();}});
            cal.manageFields("dateFrom", "dateFrom", "%d.%m.%Y");
            cal.manageFields("dateTo", "dateTo", "%d.%m.%Y");
            cal.setLanguage(curLang);

            if(window._configuration.get("searchType")!=='quick'){
                $('#facilities').multiSelect();
            }
            $("#mkSearch").bind("click",function(){
                            search();
                        });
        };

       this.getTemplate=function(tmplName, isPartial,custom){
            var tmplContent;
            if(_.isString(custom)){
                 tmplContent=custom;
            }else{
                 tmplContent=$("#".concat(tmplName)).html();
            }
            if(_.isBoolean(isPartial) && isPartial){
                try{
                    ich.addPartial(tmplName,tmplContent);
                }
                    catch(e){console.log(e)}
            }else{
                try{
                    ich.addTemplate(tmplName,tmplContent);
                }catch(e){console.log("Error template: "+e)}
            }
        };

        this.tryGetFromCache=function(key){
            var result=$.jStore.get(key);
            if(result===undefined || result===null){
                result=null;
            }
            return result;
        }

        var HotelsList=Backbone.Collection.extend({
            model:Hotel,
            url:'hotel/search',
            hotelsCount:0,
            offersCount:0,
            fetchData:function(service,lang,count,useCache){
                var self=this;
                return $.ajax({
                    url:service.concat(self.url),
                    data:{limit:count, language:lang, searchType:"QUICK",sortType:"POPULARITY", sortDirection:"DESC"},
                    type:"POST",
                    success:function(hotels){
                       if(useCache){
                            $.jStore.set('hotelsList_'.concat(lang),hotels.hotelList);
                            self.refresh($.jStore.get('hotelsList_'.concat(lang)));
                       }else{
                           self.refresh(hotels.hotelList);
                       }
                        self.hotelsCount=hotels.hotelCount;
                        self.offersCount=hotels.offerCount;
                    }
                });
            }
        });

        var TopDestinations=Backbone.Collection.extend({
            model:TopDestination,
            url:'location/top/',
            fetchData:function(service,lang,useCache){
                var self=this;
                return $.ajax({
                        url:service.concat(self.url,lang),
                        success:function(topdests){
                            //console.log('top destinations done');
                           if(useCache){
                                $.jStore.set('topDestinations_'.concat(lang),topdests.locationList);
                                self.refresh($.jStore.get('topDestinations_'.concat(lang)));
                           }else{
                               self.refresh(topdests.locationList);
                           }
                        }
                    });
            },
            set:function(data){
              this.refresh(data);
              return true;
            }
        });

        var Statistics=Backbone.Collection.extend({
            model:Statistic,
            url:'statistics/',
            fetchData:function(service,useCache){
                var self=this;
                return $.ajax({
                        url:service.concat(self.url),
                        success:function(stat){
                           //console.log('done statistics');
                           if(useCache){
                                $.jStore.set('statistics',stat);
                                self.refresh($.jStore.get('statistics'));
                           }else{
                                self.refresh(stat);
                           }
                        }
                });
            },
            set:function(data){
              this.refresh(data);
              return true;
            }
        });

        var SearchLocations=Backbone.Collection.extend({
            model:SearchLocation,
            url:'location/all/',
            fetchData:function(service,lang,useCache){
                var self=this;
                return $.ajax({
                        url:service.concat(self.url,lang),
                        success:function(locations){
                           //console.log('done searchLocations');
                           if(useCache){
                                $.jStore.set('srchLocations'.concat(lang),locations.locationList);
                                self.refresh($.jStore.get('srchLocations'.concat(lang)));
                           }else{
                              self.refresh(locations.locationList);
                           }
                        }
                    });
            },
            set:function(data){
                this.refresh(data);
                return true;
            }
        });

        this.initApplication=function(config){
          $("#ltemplate").load(config.mainTemplateUrl(),function(){
                new iApp(config);
                $("#dateFrom").val(Calendar.printDate(config.get("curDate"),"%d.%m.%Y"));
                $("#dateTo").val(Calendar.printDate(config.get("dayNext"),"%d.%m.%Y"));
                Backbone.history.start();
            });
        };

        var Configuration=Backbone.Model.extend({
            defaults:{
                "ajaxMode":true,
                "serviceUrl":"/bookenizer-stubs/hms-services/",
                "lang":defLanguage,
                "searchType":"quick",
                "hotelsCount":5,
                "use_jStoreCache":false,
                "curDate":(function(){return new Date();})(),
                "dayNext":(function(){return new Date(new Date().getTime()+1000*60*60*24*2);})(),
                "statistics":new Statistics(),
                "topDestinations":new TopDestinations(),
                "srchLocations":new SearchLocations(),
                "hotels":new HotelsList()
            },
            mainTemplateUrl:function(){
                return "/Locales/".concat(this.get("lang"),"/main.html");
            },
            initData:function(isRefresh,lang){
                var self=this;
                $.ajaxSetup({
                        async:self.get('ajaxMode'),
                        dataType:'json',
                        contentTpe:'application/json; charset=utf-8'
                    });
                var svcUrl, curLang, useInternalCache;
                if(lang!==undefined && lang!==""){
                   curLang=lang;
                }else{
                  curLang=self.get("lang");
                }
                console.log("Configuration initData refresh "+ isRefresh + " lang "+  curLang);
                svcUrl=self.get('serviceUrl');
                useInternalCache=self.get('use_jStoreCache');
                if(useInternalCache){
                    var dsStat,dsTopDest,dsSrcLoc,dsHotels;
                    dsStat=tryGetFromCache('statistics');
                    dsTopDest=tryGetFromCache('topDestinations_'.concat(curLang));
                    dsSrcLoc=tryGetFromCache('srchLocations'.concat(curLang));
                    dsHotels=tryGetFromCache('hotelsList_'.concat(curLang))
                    if(dsStat!==null && dsTopDest !==null && dsSrcLoc!==null && dsHotels!==null){
                       self.get('statistics').set(dsStat);
                       self.get('topDestinations').set(dsTopDest);
                       self.get('srchLocations').set(dsSrcLoc);
                       self.get('hotels').set(dsHotels);
                       self
                        if(!isRefresh){
                            initApplication(self);
                        }else{
                           self.set({lang:curLang});
                        };
                    }else{
                        $.when(
                            self.get('statistics').fetchData(svcUrl,useInternalCache),
                            self.get('topDestinations').fetchData(svcUrl,curLang,useInternalCache),
                            self.get('srchLocations').fetchData(svcUrl,curLang,useInternalCache),
                            self.get('hotels').fetchData(svcUrl,curLang,self.get('hotelsCount'),useInternalCache)
                        ).done(function(){
                            if(!isRefresh){
                                initApplication(self);
                            }else{
                                self.set({lang:curLang});
                            };
                        });
                    }
                }else{
                    $.when(
                        self.get('statistics').fetchData(svcUrl,useInternalCache),
                        self.get('topDestinations').fetchData(svcUrl,curLang,useInternalCache),
                        self.get('srchLocations').fetchData(svcUrl,curLang,useInternalCache),
                        self.get('hotels').fetchData(svcUrl,curLang,self.get('hotelsCount'),useInternalCache)
                    ).done(function(){
                        console.log("deferred done");
                        if(!isRefresh){
                           initApplication(self);
                        }else{
                           self.set({lang:curLang});
                        };
                    });
                }
            },
            initialize:function(){
                var self=this;
                self.initData(false);
            },
            refreshData:function(lang){
                var self=this;
                var svcUrl, curLang, useInternalCache;
                self.initData(true,lang);
            }
        });

        var langCollection = Backbone.Collection.extend({
            model:Language
        });

        var LogobarView = Backbone.View.extend({
            el:$("#logobar"),
            render:function() {
                getTemplate("logobar_tmpl");
                this.el.html(ich.logobar_tmpl());
                return this;
            }
        });

        var SearchView=Backbone.View.extend({
            el:$("#searchbar_ph"),
            render:function(){
                var self=this;
                getTemplate("searchbar_tmpl");
                getTemplate("searchform_tmpl_quick");
                getTemplate("searchform_tmpl_advanced");
                getTemplate("searchType_switcher_quick");
                getTemplate("searchType_switcher_advanced");
                this.el.html(ich.searchbar_tmpl());
                var searchType=window._configuration.get("searchType");
                $("#srchMenu").empty().html(ich.templates["searchType_switcher_".concat(searchType)]);
                $("#srchFrm").empty().html(ich.templates["searchform_tmpl_".concat(searchType)]);
                $("form.searchform."+searchType+" .dest").attr("suggest_value", JSON.stringify(self.model));
                suggestor();
                return self;
            }
        });

        var FooterView = Backbone.View.extend({
            el:$("#footer"),
            render:function() {
                getTemplate("footer_tmpl");
                this.el.html(ich.footer_tmpl());
                return this;
            }
        });

        var LocationsView=Backbone.View.extend({
            el:$("#topdestblock"),
            render:function(){
                var self=this;
                getTemplate('top_dest_block_tmpl');
                getTemplate('tdb_location_item',false,'<li><a href="#!/lookup/{{cityId}}">{{city}}</a>,&nbsp;{{country}}</li>');
                self.el.html(ich.top_dest_block_tmpl());
                var locations=self.el.find('#locationsList');
                console.log("locations view");
                //debugger;
                _(self.model.toJSON()).each(function(location){
                    locations.append(ich.tdb_location_item(location));
                });
                return self;
            }
        });

        var StatisticsView=Backbone.View.extend({
            el:$("#statistics"),
            render:function(){
               var self=this;
               getTemplate('stats_block_tmpl');
               self.el.html(ich.stats_block_tmpl(self.model.toJSON()[0]));
                return self;
            }
        });

        var TopMenuView = Backbone.View.extend({
            el:$('#topbar'),
            render:function() {
                var self = this;
                getTemplate("langmenu");
                getTemplate("topbar_menu_tmpl",true);
                getTemplate("langMenu_item",false,'<li><a href="#!/lang/{{id}}" class="lang" id="{{id}}" title="{{title}}">{{title}}</a> /</li>');
                self.el.html(ich.langmenu());
                var langdiv = self.el.find("#languageSwitcher");
                _(self.model.toJSON()).each(function(langItem) {
                    langdiv.append(ich.langMenu_item(langItem));
                });
                return self;
            }
        });

        var HotelsView = Backbone.View.extend(
        {
         el:$('#hotelslist'),
         render:function(){
             var self=this;
             getTemplate("hotellist_tmpl");
             getTemplate("hotellist_item_tmpl");
             self.el.html(ich.hotellist_tmpl());
             var hotelDiv=self.el.find("#hotellist_holder");
             var jsonModel=self.model.toJSON();
             var hotelCount=self.model.hotelsCount;
             var offerCount=self.model.offersCount;
             _(jsonModel).each(function(hotelItem){
                console.log(hotelItem);
                hotelDiv.append(ich.hotellist_item_tmpl(hotelItem));
             });

             $("#srPager").pagination(offerCount,{items_per_page:5, prev_text:"←", next_text:"→"});
             return self;
         }
        });

        var iApp = Backbone.Controller.extend({
            _index:null,
            _languages:null,
            _logoBar:null,
            _searchForm:null,
            _topDestinations:null,
            _footer:null,
            _configuration:null,
            _statistics:null,
            _hotelsList:null,
            routes: {
                "!/lang/:id":"language",
                "!/search/:type":"search",
                "!/lookup/:cityId":"cityLookup",
                "!/card/:hotelId":"hotelCard",
                "!/select/:hotelId":"addHotel"
            },
            renderIndex:function(){
                _index.render();
                _logoBar.render();
                _topDestinations.render();
                _statistics.render();
                _searchForm.render();
                _hotelsList.render();
                _footer.render();

            },
            drawTemplates:function(isRepaint){
                //debugger;
                if(isRepaint===undefined){
                    isRepaint=false;
                }
                if(!isRepaint){
                    //debugger;
                    _languages = function() {
                        var lc = new langCollection();
                        lc.add(new Language({id:"ru",url:"/Locales/ru/",title:"Русский"}));
                        lc.add(new Language({id:"en",url:"/Locales/en/",title:"English"}));
                        lc.add(new Language({id:"de",url:"/Locales/de/",title:"Deutsch"}));
                        return lc;
                    };
                    _index = new TopMenuView({model:_languages()});
                    _logoBar = new LogobarView();
                    _searchForm=new SearchView({model:_configuration.get("srchLocations")});
                    _topDestinations=new LocationsView({model:_configuration.get("topDestinations")});
                    _statistics=new StatisticsView({model:_configuration.get("statistics")});
                    _hotelsList=new HotelsView({model:_configuration.get('hotels')});
                    _footer = new FooterView();
                     this.renderIndex();
                }else{
                    //debugger;
                  $("#ltemplate").load(_configuration.mainTemplateUrl(),function(){
                      ich.clearAll();
                      //debugger;
                      _index.render();
                      _logoBar.render();
                      _topDestinations.render();
                      _statistics.render();
                      _hotelsList.render();
                      _searchForm.render();
                      _footer.render();
                 });
                }
            },
            initMain:function(){
                  console.log('init main');
                  //self.drawTemplates(_configuration, false);
                  this.drawTemplates(false);
                  return true;
            },
            initialize:function(spec) {
                var self=this;
                _configuration=spec;
                console.log("initialized "+_configuration);
                //$.jStore.remove("topdest_ru");
                //$.jStore.remove("topdest_en");

                _configuration.bind("change:searchType",function(model,name){
                    var st, searchType, city, defCity, dateFrom,dateTo;
                    searchType=_configuration.get("searchType");
                    //todo get cached data from jstore
                    //todo save city, dates values while form switching
                    //debugger;
                    city=$("#city").val();
                    dateFrom=$("#dateFrom").val();
                    dateTo=$("#dateTo").val();

                    $("#srchMenu").empty().html(ich.templates["searchType_switcher_".concat(name)]);
                    $("#srchFrm").empty().html(ich.templates["searchform_tmpl_".concat(searchType)]);
                    $("form.searchform."+searchType+" .dest").attr("suggest_value", JSON.stringify(_configuration.get("srchLocations")));
                    suggestor();
                    self.drawTemplates(true);
                    return true;
                });
                _configuration.bind("change:lang",function(model,name){
                //todo move data retrieve here
                    //debugger;
                    console.log('lang changed handler');

                    console.log("draw templates after data resolved");
                    self.drawTemplates(true);
                    return true;
                });
                this.initMain();
            },
            hotelCard:function(hotelId){
                console.log("Hotel card selected hotelId" + hotelId);
            },
            addHotel:function(hotelId){
                console.log("hotel selected with id"+hotelId);
            },
            language:function(lang){
                 _configuration.refreshData(lang);
            },
            cityLookup:function(cityId){
                console.log("City lookup cityId"+cityId);
            },
            search:function(srcType){
                //ich.refresh();
                _configuration.set({searchType:srcType});
            }
        });

        $(document).ready(function() {
            var jStoreConfig =
            {
                flash: '/scripts/debug/jStore.Flash.html',
                json: '/scripts/debug/json2.js'
            };

            jStore.init('bookenizer', jStoreConfig, jStore.flavors.flash).engineReady(function (engine){
                var config=new Configuration();
            });
        });
    }).call(this,'ru');
</script>
</body>
</html>
