<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <title>Bookenizer: Online Reservation Service</title>
    <link rel="shortcut icon" href="favicon.ico"/>
    <link rel="stylesheet" type="text/css" href="/styles/layout.css" medvia="all">
    <link rel="stylesheet" type="text/css" href="/styles/print.css" media="print">
    <link rel="stylesheet" type="text/css" href="/styles/jscal2.css" media="all">
    <link rel="stylesheet" type="text/css" href="/styles/jquery.multiSelect.css" media="screen">
</head>
<body class="popular">
<div id="ltemplate"></div>
<div id="mtemplate"></div>
<div id="container">
    <div id="wrapper">
        <div id="content">

            <div id="head">

                <div id="topbar">

                </div>

                <div class="close-full"></div>

                <div id="logobar" class="vcard"></div>
            </div>

            <span id="searchbar_ph"></span>

            <div id="main">
                <div class="opener"></div>

                <div id="sidebar">
                    <span id="tdbHolder" class="template_emb"></span>
                    <div class="hr"></div>
                    <span id="statistics" class="template_emb"></span>
                </div>
                <div id="mainbar">
                    <span id="hotelslist" class="template_emb"></span>
                </div>
                <div class="closer"></div>
            </div>

        </div>
    </div>
</div>
<div id="footer"></div>
<script type="text/javascript" src="/scripts/debug/xdate.js"></script>
<script type="text/javascript" src="/scripts/debug/jscal2.js"></script>
<script type="text/javascript" src="/scripts/lang/en.js"></script>
<script type="text/javascript" src="/scripts/lang/ru.js"></script>
<script type="text/javascript" src="/scripts/lang/de.js"></script>
<script type="text/javascript" src="/scripts/debug/json2.js"></script>
<script type="text/javascript" src="/scripts/jquery-1.6.1.min.js"></script>
<script type="text/javascript" src="/scripts/js-webshim/minified/extras/modernizr-custom.js"></script>
<script type="text/javascript" src="/scripts/js-webshim/minified/extras/loaders/yepnope.min.js"></script>
<script type="text/javascript" src="/scripts/js-webshim/minified/extras/mousepress.js"></script>
<script type="text/javascript" src="/scripts/js-webshim/dev/polyfiller.js"></script>
<script type="text/javascript" src="/scripts/debug/jquery.form.js"></script>
<script type="text/javascript" src="/scripts/debug/jquery.bgiframe.min.js"></script>
<script type="text/javascript" src="/scripts/debug/jquery.multiSelect.js"></script>
<script type="text/javascript" src="/scripts/debug/underscore.js"></script>
<script type="text/javascript" src="/scripts/debug/backbone.js"></script>
<script type="text/javascript" src="/scripts/debug/mustache.js"></script>
<script type="text/javascript" src="/scripts/debug/ICanHaz.js"></script>
<script type="text/javascript" src="/scripts/debug/class.js"></script>
<script type="text/javascript" src="/scripts/debug/gsuggest.js"></script>
<script type="text/javascript" src="/scripts/debug/jquery.pagination.js"></script>
<script type="text/javascript" src="/scripts/debug/xcommon.js"></script>
<script type="text/javascript" src="/scripts/models.js"></script>

<!--<script src="http://maps.google.com/maps?file=api&amp;v=2&amp;key=ABQIAAAAue-p4aGvO8316p45wNBlhBRlrZjuTPwvKSUZIF0_dsu12LmfuBQXsvcXvfazwWVzCQlwG4CP2O6mBQ" type="text/javascript"></script>-->
<script src="http://maps.google.com/maps?file=api&amp;v=2&amp;key=ABQIAAAAue-p4aGvO8316p45wNBlhBRIrSlBPavw7Ifq7KLBpU4q9tB4eBSDxh9Cn5W60dBeurP_D8-QpTvthg" type="text/javascript"></script>
<script type="text/javascript">
//$.webshims.setOptions('forms', { overrideMessages: true });
$.webshims.polyfill('lightweight');
    (function(defLanguage) {
        var layoutTypes={INIT:0,SEARCH:1,PROFILE:2,HOTELCARD:3};
        var  xSignIn;

        var setSearchParameters=function(searchType){
            var cityId=getCriteriaValue("cityId");
            if(cityId<=0){
//                $("#error_city").show();
                return false;
            }
//            $("#error_city").hide();

            var formToProcess=$("#searchform").ajaxForm();
                var criteria=window._configuration.get("searchCriteria");

                if(window._configuration.get("searchType")==="quick"){
                    criteria.searchType="QUICK";
                    updateSearchCriteria("dateFrom",$("#dateFrom,formToProcess").val());
                    updateSearchCriteria("dateTo",$("#dateTo,formToProcess").val());
                }
                else{
                      criteria.searchType="ADVANCED";
                      var fieldArray=_.compact(formToProcess.serializeArray());
                      var facilities=[];
                      _.each(fieldArray,function(arg){
                          if(arg.name!=='city' && arg.name!=='cityId'){
                              if(arg.name!=="dateFrom" && arg.name!=="dateTo"){
                                   if(arg.name!=='facilities[]'){
                                       if(arg.value!=="" && arg.value!==undefined){
                                            updateSearchCriteria(arg.name,arg.value);
                                       }
                                   }else{
                                       facilities.push(arg.value);
                                   }
                                  }else{
                                     updateSearchCriteria("advDateFrom",JSON.stringify($("#dateFrom,formToProcess").val()));
                                     updateSearchCriteria("advDateTo",JSON.stringify($("#dateTo,formToProcess").val()));
                                  }
                        }
                      });
                      if(facilities.length>0){
                          updateSearchCriteria("facilities",facilities.join(','));
                      }
                      //_.extend(criteria,{dateFrom:$("#dateFrom,formToProcess").val()});
                      //_.extend(criteria,{dateTo:$("#dateTo,formToProcess").val()});
                      //_.extend(criteria,{dateTo:$("#numberOfPersons,formToProcess").val()});

                }
                if(cityId!==null){
                    updateSearchCriteria("cityId",cityId);
                }
                return true;
            //});
        };

        var caching=(function(store){
            store.add=function(key,dataToCache){
                    try{
                        //if(localStorage.getItem(key)===null){
                            localStorage.setItem(key,dataToCache);
                        //}
                        return JSON.parse(localStorage.getItem(key));
                    }catch(e){}
            };
            store.get=function(key){
                    if(localStorage.getItem(key)!==null){
                        return JSON.parse(localStorage.getItem(key));
                    }
                    return null;
            };
            store.refresh=function(key,dataToCache){
                    try{
                        localStorage.setItem(key,dataToCache);
                    }catch(e){}
            };
            store.empty=function(){
                localStorage.clear();
            };
            return store;
        })(caching || {});



        var fillMealsPrice=function(mealItem){
            var index=0;
          _.each(mealItem,function(m){
                var ms={name:"",price:0,sysId:""};
                ms.name=m.displayName;
                ms.price=Number(m.price);
                ms.sysId=m.meal;
                xData.meals.addIndex(++index,ms);
          });
        }

        var fillCalcData=function(hotelItem){
            var index=0,rcl;
            if(hotelItem.MealPrice!==undefined){
                fillMealsPrice(hotelItem.MealPrice.mealPriceItemList);
            }
            if(hotelItem.RoomCategories!==undefined){
                rcl=hotelItem.RoomCategories.roomCategoryList;
            }else{
                rcl=hotelItem[0].roomCategoryList;
            }
            _.each(rcl,function(r){
                  var roomObject={
                      categoryId:-1,
                      name:"",
                      avail:0,
                      price:0,
                      extrabeds:{num:0,price:0}
                  };
                  roomObject.categoryId=r.categoryId;
                  roomObject.name=r.name;
                  if(r.Offers.offerList.length>0){
                      roomObject.avail=r.Offers.offerList.length;
                      _.each(r.Offers.offerList,function(o){
                           roomObject.price+=Number(o.price);
                           roomObject.extrabeds.num=Number(o.countAvailable);
                           roomObject.extrabeds.price=Number(o.extraBedPrice);
                      });
                  }
                xData.apt.addIndex(++index,roomObject);
            });
        };

        var updateSearchCriteria=function(fieldName,data){
            var criteria=window._configuration.get("searchCriteria");
            var keys=_.keys(criteria);
            //debugger;
            if(!_.include(keys,fieldName)){
                eval("_.extend(criteria,{"+fieldName+":data})");
            }else{
               eval("criteria."+fieldName+"=data");
            }
        };

        var getCriteriaValue=function(key){
            var criteria=window._configuration.get("searchCriteria");
            var keys=_.keys(criteria);
            if(_.include(keys,key)){
                return eval("criteria."+key);
            }
            return null;
        };

        var setLayout=function(layout){
            var dfr=$.Deferred();
             switch(layout){
                 case layoutTypes.INIT:
                 case layoutTypes.PROFILE:
                 case layoutTypes.SEARCH:
                        getContent("/Layouts/layoutSearchResult.html",$("#main"));
                        dfr.resolve();
                        break;
                 case layoutTypes.HOTELCARD:
                        getContent("/Layouts/layoutHotelCard.html",$("#main"));
                            dfr.resolve();
                        break;
                 default:
                    dfr.resolve();
                    break;
             }
            return dfr.promise();
        };

        var getContent=function(url,elemToLoad){
            elemToLoad.empty();
            elemToLoad.load(url);
        };

        var suggestor=function(){
            var curLang=window._configuration.get("lang");
            var self=this;
            $.gsuggest({
                inlineText: function(data) { return data.city + ", " + data.country; },
                inlineId: function(data) { return data.cityId; },
                dataSort: function(a,b) { return (a.city < b.city) ? -1 : ((a.city === b.city) ? 0 : 1); },
                callback:function(data){
                    updateSearchCriteria("cityId",data.id);
                }
            });
            var cal=Calendar.setup( {selectionType : Calendar.SEL_MULTIPLE, timeFormat:24, firstDay : 0, weekNumbers : false, showOthers:true, onSelect:function(){fixDate(this.inputField.id);this.hide();}});
            cal.manageFields("dateFrom", "dateFrom", "%d.%m.%Y");
            cal.manageFields("dateTo", "dateTo", "%d.%m.%Y");
            initCalendar.call(self,{dtStart:{fldName:"#dateFrom"},dtEnd:{fldName:"#dateTo"}});
            cal.setLanguage(curLang);

            if(window._configuration.get("searchType")!=='quick'){
                $('#facilities').multiSelect({selectAll:false,oneOrMoreSelected: '*'});
            }
        };

       this.getTemplate=function(tmplName, isPartial,custom){
            var tmplContent;
            if(_.isString(custom)){
                 tmplContent=custom;
            }else{
                 tmplContent=$("#".concat(tmplName)).html();
            }
            if(_.isBoolean(isPartial) && isPartial){
                try{
                    ich.addPartial(tmplName,tmplContent);
                }
                    catch(e){
                        //console.log(e);
                    }
            }else{
                try{
                    ich.addTemplate(tmplName,tmplContent);
                }catch(e){
                    //console.log("Error template: "+e);
                }
            }
        };

        this.tryGetFromCache=function(key){
            var result=caching.get(key);
            if(result===undefined || result===null){
                //TODO if no data in cache need to perform appropriated ajax request
                result=null;
            }
            return result;
        };


        var handlePaginationClick=function(page_index, jq){
          var offset=window._configuration.get("searchCriteria").offset;
          var hotelsCount=window._configuration.get("hotelsCount");
          if(offset!==null && offset!==undefined){
              window._configuration.get("searchCriteria").offset=page_index*hotelsCount;
          }else{
              _.extend(window._configuration.get("searchCriteria"),{offset:(page_index*hotelsCount)});
          }
        };

        var handleReviewsPagination=function(page_index, jq){
            debugger;
        };

        var OffersCalc=Backbone.Collection.extend({
            model:Offers,
            url:'hotel/categories',
            fetchData:function(args){
                var self=this;
                var dfr=$.Deferred();
                $.ajax({
                    url:args.svcUrl.concat(self.url),
                    data:{"id":_configuration.get("searchCriteria").hotelId,"dateFrom":_configuration.get("searchCriteria").dateFrom,"dateTo":_configuration.get("searchCriteria").dateTo,"language":args.curLang},
                    type:"GET",
                    success:function(offers){
                        self.refresh(offers);
                        dfr.resolveWith(offers);
                    }
                });
                return dfr.promise();
            }
        });

        var HotelsList=Backbone.Collection.extend({
            model:Hotel,
            url:'hotel/search',
            hotelsCount:0,
            offersCount:0,
            fetchData:function(args,criteria){
                var self=this;
                var dfr=$.Deferred();
                $.ajax({url:args.svcUrl.concat(self.url),
                    data:criteria,
                    type:"POST",
                    success:function(hotels){
                           if(args.useInternalCache){
                               self.refresh(caching.add('hotelsList_'.concat(args.curLang),JSON.stringify(hotels)));
                           }else{
                               self.refresh(hotels);
                           }

                        self.hotelsCount=hotels.hotelCount;
                        self.offersCount=hotels.offerCount;
                        dfr.resolve();
                    }
                });
                return dfr.promise();
            }
        });

        var HotelCard=Backbone.Collection.extend({
            model:Hotel,
            url:'hotel/card/',
            fetchData:function(args){
                var self=this;
                var dfr=$.Deferred();
                    $.ajax({
                        url:args.svcUrl.concat(self.url),
                        type:"GET",
                        data:{"id":_configuration.get("searchCriteria").hotelId,"dateFrom":_configuration.get("searchCriteria").dateFrom,"dateTo":_configuration.get("searchCriteria").dateTo,"language":args.curLang},
                        success:function(cards){
                            self.refresh(cards);
                            dfr.resolve();
                        },
                        error:function(){
                            alert("error");
                        }
                    });
                return dfr.promise();
            }
        });

        var RandomOffers=Backbone.Collection.extend({
            model:Hotel,
            url:'hotel/search',
            hotelsCount:0,
            offersCount:0,
            fetchData:function(args,criteria){
                var self=this;
                return $.ajax({
                        url:args.svcUrl.concat(self.url),
                        data:criteria,
                        type:"POST",
                        success:function(randoffers){
                               self.refresh(randoffers.hotelList);
                        }
                    });
            },
            set:function(data){
              this.refresh(data);
              return true;
            }
        });

        var TopDestinations=Backbone.Collection.extend({
            model:TopDestination,
            url:'location/top/',
            fetchData:function(args){
                var self=this;
                var dfr=$.Deferred();
                $.ajax({
                        url:args.svcUrl.concat(self.url,args.curLang),
                        type:"GET",
                        success:function(topdests){
                            //console.log('top destinations done');
                           if(args.useInternalCache){
                                self.refresh(caching.add('topDestinations_'.concat(args.curLang),JSON.stringify(topdests.locationList)));
                           }else{
                               self.refresh(topdests.locationList);
                           }
                           dfr.resolve();
                        }
                    });
                return dfr.promise();

            },
            set:function(data){
              this.refresh(data);
              return true;
            }
        });

        var Statistics=Backbone.Collection.extend({
            model:Statistic,
            url:'statistics/',
            fetchData:function(args){
                var self=this;
                var dfr=$.Deferred();
                $.ajax({
                        url:args.svcUrl.concat(self.url),
                        type:"GET",
                        success:function(stat){
                           //console.log('done statistics');
                           if(args.useInternalCache){
                               self.refresh(caching.add('statistics',JSON.stringify(stat)));
                           }else{
                              self.refresh(stat);
                           }
                            dfr.resolve();
                        }
                });
                return dfr.promise();
            },
            set:function(data){
              this.refresh(data);
              return true;
            }
        });

        var SearchLocations=Backbone.Collection.extend({
            model:SearchLocation,
            url:'location/all/',
            fetchData:function(args){
                var self=this;
                var dfr=$.Deferred();
                $.ajax({
                        url:args.svcUrl.concat(self.url,args.curLang),
                        type:"GET",
                        success:function(locations){
                           if(args.useInternalCache){
                               self.refresh(caching.add('srchLocations_'.concat(args.curLang),JSON.stringify(locations.locationList)));
                           }else{
                              self.refresh(locations.locationList);
                           }
                            dfr.resolve();
                        }
                    });
                return dfr.promise();
            },
            set:function(data){
                this.refresh(data);
                return true;
            }
        });

        var initSearchResults=function(config){
            var dfd=$.Deferred();
            $("#mtemplate").load(config.searchResultsTemplateUrl(),function(){
                $("body").attr("class","").addClass("results");
                dfd.resolve();
            });
            return dfd.promise();
        };

        var initHotelCardTemplate=function(config){
            var dfd=$.Deferred();
            $("#mtemplate").load(config.hotelCardTemplateUrl(),function(){
                dfd.resolve();
            });
            return dfd.promise();
        }

        var initMainTemplate=function(){
            $("#ltemplate").load(this.mainTemplateUrl(),function(){
                    $("body").attr("class","").addClass("popular");
                });
        };

        var initCalendar=function(dts){
            var dtStart,dtEnd,srcCriteria;
            srcCriteria=_configuration.get("searchCriteria");
            if(srcCriteria.dateFrom!==undefined && srcCriteria.dateFrom!==""){
                dtStart=Calendar.parseDate(srcCriteria.dateFrom,false);
                dtEnd=Calendar.parseDate(srcCriteria.dateTo,false);
            }else{
                dtStart=_configuration.get("curDate");
                dtEnd=_configuration.get("dayNext");
            }
            $(dts.dtStart.fldName).val(Calendar.printDate(dtStart,"%d.%m.%Y"));
            $(dts.dtEnd.fldName).val(Calendar.printDate(dtEnd,"%d.%m.%Y"));
        };

        var initCalcCalendar=function(){
            var cal=Calendar.setup( {selectionType : Calendar.SEL_MULTIPLE, timeFormat:24, firstDay : 0, weekNumbers : false, showOthers:true, onSelect:function(){fixDate(this.inputField.id);this.hide();}});
             initCalendar.call(self,{dtStart:{fldName:"#order_from"},dtEnd:{fldName:"#order_to"}});
             cal.manageFields("order_from", "order_from", "%d.%m.%Y");
             cal.manageFields("order_to", "order_to", "%d.%m.%Y");
             cal.setLanguage(_configuration.get("lang"));
            return cal;
        }

        var initApplication=function(){
            var self=this;
            $.when(initMainTemplate.call(self)).then(function(){
                 $("#mtemplate").empty();
                new iApp(self);
                _configuration.initSearchCriteria();
                Backbone.history.start();
            });
        };

        var wait = function(time) {
             return $.Deferred(function(dfd) {
            setTimeout(dfd.resolve(), time);
        });
}
        var argumentsStruct = function(isRefresh, lang, isSearchRequest) {
            var self = this;
            var args = {
                svcUrl:null,
                curLang:null,
                useInternalCache:null,
                isRefresh:false,
                isSearchRequest:false
            };

            if (lang !== undefined && lang !== "") {
                args.curLang = lang;
            } else {
                args.curLang = self.get("lang");
            }
            args.svcUrl = self.get("serviceUrl");
            args.useInternalCache = self.get("use_jStoreCache");
            if (isRefresh !== undefined) {
                args.isRefresh = isRefresh;
            }
            if(isSearchRequest!==undefined){
                args.isSearchRequest=isSearchRequest;
            }
            return args;
        };

        var fillInitDataStructures=function(args){
            var self=this;
            $.when(
                    self.defaults.statistics.fetchData(args),
                    self.defaults.topDestinations.fetchData(args),
                    self.defaults.srchLocations.fetchData(args),
                    self.defaults.hotels.fetchData(args,SearchCriteria)
                    ).then(function(){
                        debugger;
                        if(!args.isRefresh){
                            initApplication.call(self);
                        }else{
                            self.set({"lang":args.curLang});
                        }
                    }).fail(function(){
                        alert("fetch data failed");
                    });
            //.then(function(){$.noop()});
        };

        var Configuration=Backbone.Model.extend({
            defaults:{
                "ajaxMode":false,
                "serviceUrl":"/bookenizer-stubs/hms-services/",
                "lang":defLanguage,
                "searchType":"quick",
                "hotelsCount":5,
                "randomHotelsCount":3,
                "use_jStoreCache":true,
                "curDate":(function(curDate){return curDate;})(new Date()),
                "dayNext":(function(curDate){return new Date(curDate.getTime()+1000*60*60*24*2);})(new Date()),
                "statistics":new Statistics(),
                "searchCriteria":SearchCriteria,
                "topDestinations":new TopDestinations(),
                "srchLocations":new SearchLocations(),
                "hotels":new HotelsList(),
                "offers":new  OffersCalc(),
                "randomOffers":new RandomOffers(),
                "hotelCard":new HotelCard(),
                "roCount":0,
                "searchResult":new HotelsList(),
                "defaultSortOrder":"ASC",
                "defaultSortType":"NAME"
            },
            resetSearchCriteria:function(){
                var self=this;
                SearchCriteria={};
                _.defaults(SearchCriteria,{
                    cityId:0,
                    language:this.get("lang"),
                    searchType:"QUICK",
                    limit:this.get("use_jStoreCache")?-1:this.get("hotelsCount"),
                    sortType:this.get("defaultSortType"),
                    sortDirection:this.get("defaultSortOrder")});
            },
            mainTemplateUrl:function(){
                return "/Locales/".concat(this.get("lang"),"/main.html");
            },
            searchResultsTemplateUrl:function(){
                return "/Locales/".concat(this.get("lang"),"/searchResults.html");
            },
            hotelCardTemplateUrl:function(){
                return "/Locales/".concat(this.get("lang"),"/hotelcard.html");
            },
            initData:function(isRefresh,lang){
                var self=this;
                $.ajaxSetup({
                        async:self.get('ajaxMode'),
                        dataType:'json',
                        //contentType:'application/json; charset=utf-8',
                        cache:false
                    });
                var args=argumentsStruct.call(self,isRefresh,lang);
                if(args.useInternalCache && !args.isRefresh){
                    var dsStat,dsTopDest,dsSrcLoc,dsHotels;
                    //TODO remove tryGetFromCache
                    dsStat=tryGetFromCache('statistics');
                    dsTopDest=tryGetFromCache('topDestinations_'.concat(args.curLang));
                    dsSrcLoc=tryGetFromCache('srchLocations_'.concat(args.curLang));
                    dsHotels=tryGetFromCache('hotelsList_'.concat(args.curLang));

                    if(dsStat!==null && dsTopDest !==null && dsSrcLoc!==null && dsHotels!==null){
                       self.defaults.statistics.add(dsStat);
                       self.defaults.topDestinations.add(dsTopDest);
                       self.defaults.srchLocations.add(dsSrcLoc);
                       self.defaults.hotels.add(dsHotels);
                        if(!isRefresh){
                            initApplication.call(self);
                        }else{
                            self.set({"lang":args.curLang});
                        }
                    }else{
                        fillInitDataStructures.call(self,args);
                    }
                }else{
                       fillInitDataStructures.call(self,args);
                }
            },
            initialize:function(){
                var self=this;
                self.initSearchCriteria.call(self);
                self.initData.call(self,false);
            },
            refreshData:function(lang){
                var self=this;
                self.initData.call(self,true,lang);
            },
            initHotelCard:function(){
                var self=this;
                var args=argumentsStruct.call(self);
                return self.defaults.hotelCard.fetchData(args);
            },
            initSearchCriteria:function(){
                (function(criteria,settings){
                    criteria.limit= settings.use_jStoreCache? -1: settings.hotelsCount;
                    criteria.language=settings.lang;
                    criteria.searchType=settings.searchType.toUpperCase();
                })(this.defaults.searchCriteria,this.defaults);
            },
            initRandomOffers:function(){
                var self=this;
                var args=argumentsStruct.call(self);
                var sCriteria=_.clone(self.defaults.searchCriteria);
                _.extend(sCriteria,{limit:3,sortType:"POPULARITY"});
                return self.defaults.randomOffers.fetchData(args,sCriteria);
            },
            makeSearch:function(){
                var self=this;
                var args=argumentsStruct.call(self);
                args.isSearchRequest=true;
                return self.defaults.hotels.fetchData(args,self.defaults.searchCriteria);
            },
            getOffers:function(){
                var self=this;
                var args=argumentsStruct.call(self);
                return self.defaults.offers.fetchData(args);
            }
        });

        var langCollection = Backbone.Collection.extend({
            model:Language
        });

        var SortOrderCollection=Backbone.Collection.extend({
            model:SortOrder
        });

        var LogobarView = Backbone.View.extend({
            el:$("#logobar"),
            render:function() {
                getTemplate("logobar_tmpl");
                this.el.html(ich.logobar_tmpl());
                return this;
            }
        });

        var SearchView=Backbone.View.extend({
            events:{"submit #searchform":"handleSubmit"},
            el:$("#searchbar_ph"),
            render:function(){
                var self=this;
                getTemplate("searchbar_tmpl");
                getTemplate("searchform_tmpl_quick");
                getTemplate("searchform_tmpl_advanced");
                getTemplate("searchType_switcher_quick");
                getTemplate("searchType_switcher_advanced");
                this.el.html(ich.searchbar_tmpl());
                var searchType=window._configuration.get("searchType");
                $("#srchMenu").empty().html(ich.templates["searchType_switcher_".concat(searchType)]);
                $("#srchFrm").empty().html(ich.templates["searchform_tmpl_".concat(searchType)]);
                $("form.searchform."+searchType+" .dest").attr("suggest_value", JSON.stringify(self.model));
                suggestor();
                return self;
            },
            handleSubmit:function(data){
                var searchType=window._configuration.get("searchType");
                Backbone.history.saveLocation("#!/search/do/".concat(searchType));
                this.trigger("searchForm:search",searchType);
            }
        });

        var FooterView = Backbone.View.extend({
            el:$("#footer"),
            render:function() {
                getTemplate("footer_tmpl");
                this.el.html(ich.footer_tmpl());
                return this;
            }
        });

        var LocationsView=Backbone.View.extend({
            el:$("#tdbHolder"),
            render:function(){
                var self=this;
                getTemplate('top_dest_block_tmpl');
                getTemplate('tdb_location_item',false,'<li><a href="#!/lookup/{{cityId}}">{{city}}</a>,&nbsp;{{country}}</li>');
                self.el.html(ich.top_dest_block_tmpl());
                var locations=self.el.find('#locationsList');
                //console.log("locations view");
                _(self.model.toJSON()).each(function(location){
                    locations.append(ich.tdb_location_item(location));
                });
                return self;
            }
        });

        var RandomOffersView=Backbone.View.extend({
           el:$('#randomsHolder'),
            render:function(){
             var self=this;
             getTemplate("ro_block_tmpl");
             getTemplate("ro_item_tmpl");
             self.el=$('#randomsHolder').empty();
             self.el.html(ich.ro_block_tmpl());
             var roDiv=$("#randomslist");
             var jsonModel=self.model.toJSON();
             //console.log("jsonModel count "+jsonModel.length);
             _(jsonModel).each(function(hotelItem){
                roDiv.append(ich.ro_item_tmpl(hotelItem));
             });
             return self;
         }
        });

        var StatisticsView=Backbone.View.extend({
            el:$("#statistics"),
            render:function(){
               var self=this;
               getTemplate('stats_block_tmpl');
               self.el.html(ich.stats_block_tmpl(self.model.toJSON()[0]));
               return self;
            },
            reRender:function(){
                var self=this;
                self.el=$("#statistics");
                self.render();
            }
        });

        var SortBarView=Backbone.View.extend({
            el:$("#sortmenuholder"),
            render:function(){
                var self=this;
                if(self.el.length<1){
                    self.el=$("#sortmenuholder");
                }
                getTemplate("sortmenu");
                self.el.html(ich.sortmenu(self.model));
                return self;
            }
        });

        var TopMenuView = Backbone.View.extend({
            el:$('#topbar'),
            render:function() {
                var self = this;
                getTemplate("langmenu");
                getTemplate("ddlLangMenu_tmpl");
                getTemplate("topbar_menu_tmpl",true);
                getTemplate("langMenu_item",false,'<li><a href="#!/lang/{{id}}" class="lang" id="{{id}}" title="{{title}}">{{title}}</a> {{divider}}</li>');
                self.el.html(ich.langmenu());
                var langdiv = self.el.find("#languageSwitcher");
                _(self.model.toJSON()).each(function(langItem,num) {
                    langdiv.append(ich.langMenu_item( (num < self.model.length - 1)? _.extend(langItem,{divider:"/"}): _.extend(langItem,{divider:""})));
                });
                langdiv.append(ich.ddlLangMenu_tmpl());
                xSignIn = new iSignIn({id:"#loginform", btActivator:"#bt_login", btRegister:"#bt_register", btAction:"#bt_login_action",  pre:"#lp", idMail:"#mail", idPass:"#pass", idPassOpen:"#pass_open"});
                return self;
            }
        });

        var PagedHotelsView=Backbone.View.extend({
         el:$('#hotellist_holder'),
         render:function(){
             //debugger;
             var self=this;
             getTemplate("hotellist_item_tmpl");
             self.el=$('#hotellist_holder').empty();
             //debugger;
             var jsonModel=self.model.toJSON()[0];
             var hotelCount=jsonModel['hotelCount'];
             var offerCount=jsonModel['offersCount'];
             _(jsonModel['hotelList']).each(function(hotelItem){
                self.el.append(ich.hotellist_item_tmpl(hotelItem));
             });
             return self;
         }
        });

        var HotelsView = Backbone.View.extend(
                {
                    el:$('#hotelslist'),
                    render:function(isResultsView) {
                        var self = this;
                        if (isResultsView === undefined || isResultsView !== true) {
                            getTemplate("hotellist_tmpl");
                            getTemplate("hotellist_item_tmpl");
                            self.el.html(ich.hotellist_tmpl());
                        } else {
                            getTemplate("src_hotellist_tmpl");
                            getTemplate("hotellist_item_tmpl");
                            self.el.html(ich.src_hotellist_tmpl());
                        }
                        var hc=_configuration.get("hotelsCount");
                        var hotelDiv = self.el.find("#hotellist_holder");
                        var jsonModel = self.model.toJSON()[0];
                        var hotelCount = jsonModel['hotelCount'];
                        var offerCount = jsonModel['offerCount'];
                        _(jsonModel['hotelList']).each(function(hotelItem,i) {
                            if(i<hc){
                                hotelDiv.append(ich.hotellist_item_tmpl(hotelItem));
                            }
                        });
                        var page_index=_configuration.get("searchCriteria").pageIndex;
                        if(page_index===undefined){
                            page_index=0;
                        }
                        $("#srPager").pagination(hotelCount, {items_per_page:hc, current_page:Number(page_index), prev_text:"←", link_to:"#!/hl/page/__id__", next_text:"→",callback:handlePaginationClick});
                        return self;
                    },
                    reRender:function(isResultsView) {
                        var self = this;
                        self.el = $("#hotelslist");
                        self.render(isResultsView);
                    }
                });

        var HotelCardView=Backbone.View.extend(
                {
                    el:$('#hotel_info_holder'),
                    render:function(){
                        var self=this;

                        getTemplate("hotelcard_tmpl");
                        if(self.el!==undefined && self.el.length<1){
                            self.el=$('#hotel_info_holder');
                        }
                        getTemplate("hc_ro_item_tmpl");
                        getTemplate("gallery_tmpl");
                        getTemplate("mapa_tmpl");
                        getTemplate("apt_gallery_template");
                        getTemplate("calc_template");
                        getTemplate("hc_contacts_tmpl",true);
                        getTemplate("dl-item-tmpl",true);
                        getTemplate("ro_ratings_tmpl");
                        getTemplate("reviews_tmpl");
                        getTemplate("user_review_tmpl",true);
                        getTemplate("user_rating_tmpl",true);
                        //getTemplate("room_category_offers",true);
                        self.el.html(ich.hotelcard_tmpl());
                        var hotelDiv=$(".info-1",self.el);
                        var ratingsDiv=$(".info-2",self.el);
                        var footerDiv=$("#footer");
                        //var calcHolder=$("#calcHolder");
                        var calcHolder=$("#orderblock");
                        var reviewsHolder;
                        var reviews={};
                         xData.apt=new iArray();
                         xData.meals = new iArray();
                         xData.order = new iArray({
                            1:{type:1, num:1, extrabeds:0},
                            meals:{type:1, persons:2}
                         });
                        _(self.model.toJSON()).each(function(hotelItem) {
                            var currency = hotelItem.currency;
                            var photosCount = hotelItem.Photos.photoList.length;
                            var categoriesEnum={};
                            var roomIterator = 0;
                            var photoIterator=0;

                            fillCalcData(hotelItem);
                            _.extend(reviews,{Reviews:hotelItem.Reviews});

                            var hi = _.extend(hotelItem, {calc:function() {
                                        return function(text, render) {
                                            var arg = 8;
                                            try {
                                                arg = parseFloat(render(text));
                                                if (arg > 8)
                                                    arg = 8;
                                            } catch(e) {
                                                arg = 8;
                                            }
                                            return parseInt(arg * 12.5)
                                        };
                                    }}, {hcPrice:function() {
                                        return function(text, render) {
                                            return currency + " " + render(text);
                                        };
                                    }}, {hcPhotos:function() {
                                        return photosCount;
                                    }}, {hcRoomCategory:function() {
                                        return ++roomIterator;
                                    }});
                            calcHolder.html(ich.calc_template());
                            hotelDiv.append(ich.hc_ro_item_tmpl(hotelItem));
                            ratingsDiv.append(ich.ro_ratings_tmpl(hi));
                            ich.gallery_tmpl(hi).insertAfter(footerDiv);
                            ich.mapa_tmpl(hotelItem).insertAfter(footerDiv);
                            reviewsHolder=$("#reviewsHolder");
                        });
                        GmapInit();
                        $("div.gallery > a.nou:first").addClass("current");
                        _.extend(reviews,{calc:function() {
                                        return function(text, render) {
                                            var arg = 8;
                                            try {
                                                arg = parseFloat(render(text));
                                                if (arg > 8)
                                                    arg = 8;
                                            } catch(e) {
                                                arg = 8;
                                            }
                                            return parseInt(arg * 12.5)
                                        };
                                    }});
                        $("#reviewsCache").data('reviews',reviews);
                        var revs=$("#reviewsCache").data('reviews');
                        $("#srPager").pagination(revs.Reviews.reviewList.length, {load_first_page:true, items_per_page:Number(_configuration.get("hotelsCount")), prev_text:"←", next_text:"→",callback:function(page_index,jq){
                            var self=this;
                            var dataLength=revs.Reviews.reviewList.length;
                            var max_elem=Math.min((page_index+1)*self.items_per_page,dataLength);
                            var tempReviews= $.extend(true,{},revs);
                            tempReviews.Reviews.reviewList=[];
                            for(var i=page_index*self.items_per_page;i<max_elem;i++){
                                 tempReviews.Reviews.reviewList.push($.extend({},revs.Reviews.reviewList[i]));
                            }
                            reviewsHolder.html(ich.reviews_tmpl(tempReviews));
                        }});

                        var xGallery = new iGallery({id:"#galleryform", btActivator:"#bt_showgallery", btActivatorAlt:"#bt_showgalleryAlt", btAction:"#galleryform a.close"});
                        var xMapa = new iMapa({id:"#mapaform", btActivator:"#bt_showmap", btAction:"#mapaform a.close"});
                        var apt_gallery=$("table.price > tbody > tr > td > a[id^=bt_showapt]").bind('click',function(e){
                            var offersCount,arrImages;
                            var targetName=e.target.id.split('_');
                            var targetId=targetName[targetName.length-1];
                            var attribs=self.model.models[0].attributes;
                            var obj=attribs.RoomCategories.roomCategoryList[targetId-1];
                            if(obj!==null && obj!==undefined){
                                offersCount=obj.Offers.offerList.length;
                                var price=0,startDate,endDate;
                                $.each(obj.Offers.offerList,function(i,offer){
                                    if(i===0){
                                        startDate=offer.dateFrom;
                                        endDate=offer.dateTo;
                                    }else{
                                        if(startDate>offer.dateFrom){
                                            startDate=offer.dateFrom;
                                        }
                                        if(endDate<offer.dateTo){
                                            endDate=offer.dateTo;
                                        }
                                    }
                                    //debugger;
                                    price+=parseFloat(offer.price);
                                });
                                var offer=_.extend({},{startDate:startDate},{endDate:endDate},{offerPrice:price});
                                _.extend(obj,{targetId:targetId},{currency:attribs.currency},{offer:offer});
                            }
                            ich.apt_gallery_template(obj).insertAfter(footerDiv);
                            if(obj!==null && obj!==undefined){
                                if(offersCount>0){
                                    $("#offersList").show();
                                    $(".number").text(offersCount);
                                    $(".unavailable").hide();
                                }else{
                                    $("#offersList").hide();
                                }
                            }else{
                                $("#offersList").hide();
                            }
                            var xApt = new iGallery({id:"#apt".concat(targetId,"form"), btActivator:'#'.concat(e.target.id), btAction:"#apt".concat(targetId,"form a.close"), aptId:targetId});
                            var xSubscribe = new iSubscribe({id:"#apt"+targetId+"form .subscribeform", btActivator:"#apt"+targetId+"form .bt_subscribe", btAction:"#apt"+targetId+"form .bt_subscribe_action", pre:".sp", idMail:"#apt"+targetId+"form .subscribe_mail", parent:xApt});
                            try{
                                $("#aptgalimg_"+targetId+" > img").attr("src",obj.Photos.photoList[0].large);
                                $("div.gallery > a.nou:first").addClass("current");
                            }catch(e){
                                //log no photo
                            }
                            xApt.show();
                            return false;
                        });
                         /*var cal=Calendar.setup( {selectionType : Calendar.SEL_MULTIPLE, timeFormat:24, firstDay : 0, weekNumbers : false, showOthers:true, onSelect:function(){fixDate(this.inputField.id);this.hide();}});
                         initCalendar.call(self,{dtStart:{fldName:"#order_from"},dtEnd:{fldName:"#order_to"}});
                         cal.manageFields("order_from", "order_from", "%d.%m.%Y");
                         cal.manageFields("order_to", "order_to", "%d.%m.%Y");
                         cal.setLanguage(_configuration.get("lang")); */
                        //TODO needs tob refactored!!!
                        var cal=initCalcCalendar();
                        var xOrder= new iOrder({id:"#orderblock", btActivator:".add2order"});
                         $("#findoffers").live('click',function(){
                             updateSearchCriteria("dateFrom",$("#order_from").val());
                             updateSearchCriteria("dateTo",$("#order_to").val());
                             $.when(_configuration.getOffers()).done(function(data){
                                 xData.apt=new iArray();
                                 xData.order = new iArray({
                                    1:{type:1, num:1, extrabeds:0},
                                    meals:{type:1, persons:2}
                                  });
                              });
                             fillCalcData(_configuration.get("offers").toJSON());
                             fixDate($("#order_to"));
                             calcHolder.empty().html(ich.calc_template());
                             cal=initCalcCalendar();
                             xOrder= new iOrder({id:"#orderblock", btActivator:".add2order"});
                         });

                        return self;
                    }
                }
        );

        var initSearchActivity=function(){
            var self=this;
            $.when(setLayout(layoutTypes.SEARCH),initSearchResults(_configuration),_configuration.initRandomOffers(),_configuration.makeSearch()).done(function(){
                        $("body").attr("class","").addClass("results");
                         var hotelModel=_configuration.get('hotels');
                        _sortBar=new SortBarView({model:hotelModel});
                        _randomOffers=new RandomOffersView({model:_configuration.get('randomOffers')});
                        _hotelsList=new HotelsView({model:hotelModel});
                        _sortBar.render();
                        _statistics.reRender();
                        _randomOffers.render();
                        _hotelsList.reRender(true);
                        attachSearchEvents.call(self);
                    });
        };

        var initHolelCardActivity=function(){
            var self=this;
            $.when(setLayout(layoutTypes.HOTELCARD),initHotelCardTemplate(_configuration),_configuration.initHotelCard()).done(function(){
                $("body").attr("class","").addClass("hotelcard");
                var hcModel=_configuration.get('hotelCard');
                _hotelCard=new HotelCardView({model:hcModel});
                _hotelCard.render();
                //debugger;
                _statistics.reRender();
            });
        };

        var performSearchRequest=function(objectToRender){
            var args=argumentsStruct.call(_configuration);
             _.extend(_configuration.get("searchCriteria"),{pageIndex:0});
            $.when(_configuration.get("hotels").fetchData(args,_configuration.get("searchCriteria"))).done(function(){
                    objectToRender.render();
                });
        };

        var attachSearchEvents=function(){
          //var self=this;
          $("span[id^='sbt_']").attr("class","none");
          $("#sbt_".concat(_configuration.get("defaultSortType").toLowerCase())).attr("class",_configuration.get("defaultSortOrder").toLowerCase());

          $(".clickablesort").bind("click",function(e){
                        var elem=$(e.target).children(":first");
                        var sortDirection=elem.attr("class");
                        var sortName,hrefVal;
                        hrefVal=$(e.target).attr("href");
                        var criteria= _configuration.get("searchCriteria");
                        if(sortDirection!=="none"){
                                if(sortDirection==='asc'){
                                   updateSearchCriteria("sortDirection","DESC");
                                }else{
                                   updateSearchCriteria("sortDirection","ASC");
                                }
                            sortDirection=criteria.sortDirection;
                        }else{
                            sortDirection=_configuration.get("defaultSortOrder");
                        }

                        try{
                            sortName=elem.attr("id").split('_')[1];
                        }catch(e){
                            sortName=criteria.sortType;
                        }
                        updateSearchCriteria("sortType",sortName.toUpperCase());
                        $("span[id^='sbt_']").attr("class","none");
                        elem.attr("class",sortDirection.toLowerCase());
                        _sortOrderModel.set({current:sortDirection.toLowerCase()});
                    });
        };

        var iApp = Backbone.Controller.extend({
            _index:null,
            _languages:null,
            _logoBar:null,
            _searchForm:null,
            _topDestinations:null,
            _footer:null,
            _configuration:null,
            _statistics:null,
            _hotelsList:null,
            _pagedHotelsList:null,
            _sortBar:null,
            _randomOffers:null,
            _srtOrderModel:null,
            _hotelCard:null,
            routes: {
                "!/lang/:id":"language",
                "!/search/:type":"search",
                "!/lookup/:cityId":"cityLookup",
                "!/card/:hotelId":"hotelCard",
                "!/select/:hotelId":"addHotel",
                "!/search/do/:type":"makeSearch",
                "!/hl/page/:id":"hotelListPager",
                "!/page/:id":"pager",
                "!/search/sortby/:type":"sortBy",
                "!/search/sortby/:type/:order":"sortBy",
                "!/cache/clear":"doCmd"
            },
            doCmd:function(){
                localStorage.clear();
            },
            renderIndex:function(){
                _index.render();
                _logoBar.render();
                _topDestinations.render();
                _statistics.render();
                _searchForm.render();
                _hotelsList.render();
                _footer.render();

            },
            drawTemplates:function(isRepaint){
                //debugger;
                if(isRepaint===undefined){
                    isRepaint=false;
                }
                if(!isRepaint){
                    //debugger;
                    _languages = function() {
                        var lc = new langCollection();
                        lc.add(new Language({id:"ru",url:"/Locales/ru/",title:"Русский"}));
                        lc.add(new Language({id:"en",url:"/Locales/en/",title:"English"}));
                        lc.add(new Language({id:"de",url:"/Locales/de/",title:"Deutsch"}));
                        return lc;
                    };
                    _index = new TopMenuView({model:_languages()});
                    _logoBar = new LogobarView();
                    _searchForm=new SearchView({model:_configuration.get("srchLocations")});
                    _searchForm.bind("searchForm:search",this.makeSearch);
                    _topDestinations=new LocationsView({model:_configuration.get("topDestinations")});
                    _statistics=new StatisticsView({model:_configuration.get("statistics")});
                    _hotelsList=new HotelsView({model:_configuration.get('hotels')});
                    _pagedHotelsList=new PagedHotelsView({model:_configuration.get('hotels')});
                    _footer = new FooterView();
                     this.renderIndex();
                }else{

                  $("#ltemplate").load(_configuration.mainTemplateUrl(),function(){
                      ich.clearAll();
                      //debugger;
                      //_layout.render();
                      _index.render();
                      _logoBar.render();
                      _topDestinations.render();
                      _statistics.render();
                      _hotelsList.render();
                      _searchForm.render();
                      _footer.render();
                 });
                }
            },
            initMain:function(){
                  updateSearchCriteria("cityId",0);
                  //self.drawTemplates(_configuration, false);
                  this.drawTemplates(false);
                  return true;
            },
            initialize:function(spec) {
                var self=this;
                _configuration=spec;
                _.extend(self,Backbone.events);
                _.bindAll(self,"search");
                _sortOrderModel=new SortOrder({current:_configuration.get("defaultSortOrder")});
                _sortOrderModel.bind("change",function(){
                    performSearchRequest.call(self,_pagedHotelsList);
                });
                _configuration.bind("change:searchType",function(model,name){
                    var st, searchType, city, defCity, dateFrom,dateTo;
                    searchType=_configuration.get("searchType");
                    //todo get cached data from jstore
                    //todo save city, dates values while form switching
                    //debugger;
                    city=$("#city").val();
                    dateFrom=$("#dateFrom").val();
                    dateTo=$("#dateTo").val();

                    $("#srchMenu").empty().html(ich.templates["searchType_switcher_".concat(name)]);
                    $("#srchFrm").empty().html(ich.templates["searchform_tmpl_".concat(searchType)]);
                    $("form.searchform."+searchType+" .dest").attr("suggest_value", JSON.stringify(_configuration.get("srchLocations")));
                    suggestor();
                    self.drawTemplates(true);
                    return true;
                });
                _configuration.bind("change:lang",function(model,name){
                //todo move data retrieve here
                    self.drawTemplates(true);
                    return true;
                });
                this.initMain();
            },
            hotelCard:function(hotelId){
                //$("body").attr("class","hotelcard");
                updateSearchCriteria("hotelId",hotelId);
                updateSearchCriteria("dateFrom",$("#dateFrom").val());
                updateSearchCriteria("dateTo",$("#dateTo").val());
                initHolelCardActivity.call(self);
            },
            addHotel:function(hotelId){

            },
            language:function(lang){
                updateSearchCriteria("language",lang);
                _configuration.refreshData(lang);
            },
            cityLookup:function(cityId){
                updateSearchCriteria("sortType","POPULARITY");
                updateSearchCriteria("sortDirection","DESC");
                updateSearchCriteria("cityId",cityId);
                performSearchRequest.call(this,_hotelsList);
            },
            search:function(srcType){
                //debugger;
                _configuration.set({searchType:srcType});
            },
            makeSearch:function(srcType){
                var self=this;
                //debugger;
                if(setSearchParameters(srcType)){
                    initSearchActivity.call(self);
                }
            },
            pager:function(pageNum){
                var args=argumentsStruct.call(_configuration);
                if(!args.useInternalCache){
                    performSearchRequest.call(this,_hotelsList);
                }
            },
            hotelListPager:function(pageNum){
                var args=argumentsStruct.call(_configuration);
                var pn=Number(pageNum);
                _.extend(_configuration.get("searchCriteria"),{pageIndex:pn-1});
                if(!args.useInternalCache){
                    performSearchRequest.call(this,_hotelsList);
                }else{
                    var data=caching.get('hotelsList_'.concat(args.curLang));
                    var dataLength=Number(data['hotelCount']);
                    var items_per_page=Number(_configuration.get("hotelsCount"));
                    var max_elem=Math.min(pn*items_per_page,dataLength);
                    var model=_configuration.get('hotels');
                    var pagedList={};
                    _.extend(pagedList,data);
                    pagedList['hotelList']=[];
                    for(var i=((pn-1)*items_per_page);i<max_elem;i++){
                        pagedList['hotelList'].push($.extend({},data['hotelList'][i]));
                    }
                    model.refresh(pagedList);
                    _hotelsList.render();
                }
            },
            sortBy:function(type){
                //debugger;
                //span id=sbt_type class=asc|desc|none
            }
        });
        //$(document).ready(function() {

        $.webshims.ready('DOM',function(){
              var config=new Configuration();
                $("#logo").live('click',function(){
                  //debugger;
                  config.resetSearchCriteria();
                  config.refreshData();
                });
         //caching.empty();
        });


    }).call(this,'ru');
</script>
</body>
</html>
