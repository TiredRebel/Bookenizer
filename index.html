<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <title>Bookinizer: Hotel Search</title>
    <link rel="shortcut icon" href="favicon.ico"/>
    <link rel="stylesheet" type="text/css" href="/styles/layout.css" medvia="all">
    <link rel="stylesheet" type="text/css" href="/styles/print.css" media="print">

</head>
<body class="popular">
<div id="ltemplate"></div>
<div id="container">
    <div id="wrapper">
        <div id="content">

            <div id="head">

                <div id="topbar">

                </div>

                <div class="close-full"></div>

                <div id="logobar" class="vcard"></div>
            </div>

            <span id="searchbar_ph"></span>

            <div id="main">
                <div class="opener"></div>

                <div id="sidebar">
                    <span id="topdestblock" class="template_emb"></span>
                    <div class="hr"></div>
                    <span id="statistics" class="template_emb"></span>
                </div>
                <div id="mainbar">
                    <span id="hotelslist" class="template_emb"></span>
                </div>
                <div class="closer"></div>
            </div>

        </div>
    </div>
</div>
<div id="footer"></div>
<script type="text/javascript" src="/scripts/debug/json2.js"></script>
<script type="text/javascript" src="/scripts/jquery-1.5.2.min.js"></script>
<script type="text/javascript" src="/scripts/debug/underscore.js"></script>
<script type="text/javascript" src="/scripts/debug/backbone.js"></script>
<script type="text/javascript" src="/scripts/debug/mustache.js"></script>
<script type="text/javascript" src="/scripts/debug/ICanHaz.js"></script>
<script type="text/javascript" src="/scripts/debug/class.js"></script>
<script type="text/javascript" src="/scripts/debug/jquery.jstore.js"></script>
<script type="text/javascript" src="/scripts/debug/gsuggest.js"></script>

<script type="text/javascript">
    (function() {
        var suggestor=function(){
            $.gsuggest({
                            //debug:true,
                            inlineText: function(data) { return data.city + ", " + data.country },
		                    inlineId: function(data) { return data.cityId },
		                    dataSort: function(a,b) { return (a.city < b.city) ? -1 : ((a.city == b.city) ? 0 : 1); }
            });
        };

        this.getTemplate=function(tmplName, isPartial,custom){
            var tmplContent;
            if(_.isString(custom)){
                 tmplContent=custom;
            }else{
                 tmplContent=$("#".concat(tmplName)).html();
            }
            if(_.isBoolean(isPartial) && isPartial){
                ich.addPartial(tmplName,tmplContent);
            }else{
               ich.addTemplate(tmplName,tmplContent);
            }
        };

        var TopDestination=Backbone.Model.extend({});

        var Statistic=Backbone.Model.extend({});

        var SearchLocation=Backbone.Model.extend({});

        var TopDestinations=Backbone.Collection.extend({
            model:TopDestination
        });

        var Statistics=Backbone.Collection.extend({
            model:Statistic
        });

        var SearchLocations=Backbone.Collection.extend({
            model:SearchLocation
        });


        this.fetch_TopDestinations=function(lang){
            return $.ajax({
                    async:false,
                    url:'/bookenizer-stubs/hms-services/location/top/'.concat(lang),
                    dataType:'json',
                    contentType:'application/json; charset=utf-8'
                });
            };

        this.fetch_Statistics=function(){
            return $.ajax({
                async:false,
                url:'/bookenizer-stubs/hms-services/statistics/',
                dataType:'json',
                contentType:'application/json; charset=utf-8'
            });

        };

        this.fetch_Locations=function(lang){
              return $.ajax({
                  async:false,
                  url:'/bookenizer-stubs/hms-services/location/all/'.concat(lang),
                  dataType:'json',
                  contentType:'application/json; charset=utf-8'
              });
        };

        var Language = Backbone.Model.extend();

        var Configuration=Backbone.Model.extend({
            defaults:{
                async:false,
                "lang":"ru",
                "searchType":"quick",
                "statistics":new Statistics(),
                "topDestinations":new TopDestinations(),
                "srchLocations":new SearchLocations()
            },
            mainTemplateUrl:function(){
                return "/Locales/".concat(this.get("lang"),"/main.html");
            },
            initialize:function(){
                var self=this;
                console.log("Configuration initialize "+ this.get("lang"));
                fetch_TopDestinations(self.get("lang")).success(function(topdests){
                    self.set({topDestinations:topdests.locationList});
                    $.jStore.set("topdest_".concat(self.get("lang")),self.get("topDestinations"));
                    fetch_Statistics().success(function(stat){
                        self.set({statistics:stat});
                        $.jStore.set("statistics",self.get("statistics"));
                    });
                    fetch_Locations(self.get("lang")).success(function(locations){
                        self.set({srchLocations:locations.locationList});
                        $.jStore.set("srchLocations_".concat(self.get("lang")),self.get("srchLocations"));
                    });
                });
            }
        });

        var langCollection = Backbone.Collection.extend({
            model:Language
        });

        var LogobarView = Backbone.View.extend({
            el:$("#logobar"),
            render:function() {
                getTemplate("logobar_tmpl");
                this.el.html(ich.logobar_tmpl());
                return this;
            }
        });

        var SearchView=Backbone.View.extend({
            el:$("#searchbar_ph"),
            render:function(){
                var self=this;
                getTemplate("searchbar_tmpl");
                getTemplate("searchform_tmpl_quick");
                getTemplate("searchform_tmpl_advanced");
                getTemplate("searchType_switcher_quick");
                getTemplate("searchType_switcher_advanced");
                this.el.html(ich.searchbar_tmpl());
                //debugger;
                $("#srchMenu").empty().html(ich.templates["searchType_switcher_".concat(window._configuration.get("searchType"))]);
                $("#srchFrm").empty().html(ich.templates["searchform_tmpl_".concat(window._configuration.get("searchType"))]);
                $("form.searchform."+window._configuration.get("searchType")+" .dest").attr("suggest_value", JSON.stringify(self.model));
                return this;
            }
        });

        var FooterView = Backbone.View.extend({
            el:$("#footer"),
            render:function() {
                getTemplate("footer_tmpl");
                this.el.html(ich.footer_tmpl());
                return this;
            }
        });

        var LocationsView=Backbone.View.extend({
            el:$("#topdestblock"),
            render:function(){
                var self=this;
                //debugger;
                getTemplate('top_dest_block_tmpl');
                getTemplate('tdb_location_item',false,'<li><a href="#">{{city}}</a>,{{country}}</li>');
                self.el.html(ich.top_dest_block_tmpl());
                var locations=self.el.find('#locationsList');
                _(self.model).each(function(location){
                    locations.append(ich.tdb_location_item(location));
                });
            }
        });

        var StatisticsView=Backbone.View.extend({
            el:$("#statistics"),
            render:function(){
               var self=this;
               getTemplate('stats_block_tmpl');
               //debugger;
               self.el.html(ich.stats_block_tmpl(self.model));
            }
        });

        var TopMenuView = Backbone.View.extend({
            el:$('#topbar'),
            render:function() {
                var self = this;
                getTemplate.call(this,"langmenu");
                getTemplate("topbar_menu_tmpl",true);
                getTemplate("langMenu_item",false,'<li><a href="#lang/{{id}}" class="lang" id="{{id}}" title="{{title}}">{{title}}</a> /</li>');
                console.log("langmenu " );
                self.el.html(ich.langmenu());
                var langdiv = self.el.find("#languageSwitcher");
                _(this.model.toJSON()).each(function(langItem) {
                    langdiv.append(ich.langMenu_item(langItem));
                });
                return this;
            }
        });


        var iApp = Backbone.Controller.extend({
            _index:null,
            _languages:null,
            _logoBar:null,
            _searchForm:null,
            _topDestinations:null,
            _footer:null,
            _configuration:null,
            _statistics:null,
            routes: {
                "lang/:id":"language",
                "search/:type":"search",
                "selected":"card"
            },
            renderIndex:function(){
                _index.render();
                _logoBar.render();
                _topDestinations.render();
                _statistics.render();
                _searchForm.render();
                _footer.render();
            },
            drawTemplates:function(_configuration,isRepaint){
                //debugger;
                if(isRepaint===undefined){
                    isRepaint=false;
                }
                if(!isRepaint){
                    _languages = function() {
                        var lc = new langCollection();
                        lc.add(new Language({id:"ru",url:"/Locales/ru/",title:"Русский"}));
                        lc.add(new Language({id:"en",url:"/Locales/en/",title:"English"}));
                        lc.add(new Language({id:"de",url:"/Locales/de/",title:"Deutsch"}));
                        return lc;
                    };
                    _index = new TopMenuView({model:_languages()});
                    _logoBar = new LogobarView();
                    _searchForm=new SearchView({model:_configuration.get("srchLocations")});
                    _topDestinations=new LocationsView({model:_configuration.get("topDestinations")});
                    _statistics=new StatisticsView({model:_configuration.get("statistics")});
                    _footer = new FooterView();
                     //   debugger;
                     this.renderIndex();
                }else{
                    //debugger;
                  $("#ltemplate").load(_configuration.mainTemplateUrl(),function(){
                      ich.clearAll();
                      _topDestinations.model=_configuration.get("topDestinations");
                      _statistics.model=_configuration.get("statistics");
                      _searchForm.model=_configuration.get("srchLocations");
                      _index.render();
                      _logoBar.render();

                      _topDestinations.render();
                      _statistics.render();
                      _searchForm.render();
                      _footer.render();
                 });
                }
            },
            initialize:function(spec) {
                var self=this;
                _configuration=spec;
                console.log("initialized "+_configuration);
                //$.jStore.remove("topdest_ru");
                //$.jStore.remove("topdest_en");
                _configuration.bind("change:searchType",function(model,name){
                    //alert(name);
                    var st=$.jStore.get("locations_".concat(_configuration.get("lang")));
                    //todo get cached data from jstore
                    /*alert(name);
                    if(st===null || st===undefined){

                    }*/
                    //todo save city, dates values while form switching
                    $("#srchMenu").empty().html(ich.templates["searchType_switcher_".concat(name)]);
                    $("#srchFrm").empty().html(ich.templates["searchform_tmpl_".concat(_configuration.get("searchType"))]);
                    //debugger;
                    suggestor();
                    $("form.searchform."+_configuration.get("searchType")+" .dest").attr("suggest_value", JSON.stringify(_configuration.get("srchLocations")));
                    self.drawTemplates(_configuration, false);
                    return this;
                });
                _configuration.bind("change:lang",function(model,name){
                    //todo move data retrieve here
                        var td=$.jStore.get("topdest_".concat(name));
                        var sts=$.jStore.get("statistics");
                        if(td===null || td===undefined){
                            $.when(fetch_TopDestinations(name)).then(
                                function(topdests){
                                    _configuration.set({topDestinations:topdests.locationList});
                                    $.jStore.set("topdest_".concat(name),_configuration.get("topDestinations"));
                                    if(sts===null){
                                          $.when(fetch_Statistics()).then(
                                                function(stat){
                                                    _configuration.set({statistics:stat});
                                                    $.jStore.set("statistics",_configuration.get("statistics"));
                                                },function(){
                                                    alert("Server is unavailable");
                                                });
                                    }
                                },function(){
                                    alert("Server is unavailable");
                                });
                        }else{
                              _configuration.set({topDestinations:td});
                              _configuration.set({statistics:sts});
                        }
                });
                 self.drawTemplates(_configuration, false);
                return this;
            },
            card:function(){
                debugger;
            },
            language:function(lang){
                _configuration.set({lang:lang});
                this.drawTemplates(_configuration, true);
            },
            search:function(srcType){
                _configuration.set({searchType:srcType});
                this.drawTemplates(_configuration,false);
            }
        });

        $(document).ready(function() {
            var jStoreConfig =
            {
                flash: '/scripts/debug/jStore.Flash.html',
                json: '/scripts/debug/json2.js'
            };

            jStore.init('bookenizer', jStoreConfig, jStore.flavors.flash).engineReady(function (engine){
                var config=new Configuration();
                $("#ltemplate").load(config.mainTemplateUrl(),function(){
                        new iApp(config);
                        Backbone.history.start();
                        suggestor();
                    });
                });
        });
    }).call(this);
</script>
</body>
</html>